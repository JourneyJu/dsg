version: '3.8'

# 开发环境专用的 docker-compose 配置
# 使用方式: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  basic-search:
    # 开发环境可以挂载源代码，支持热重载
    volumes:
      - ../services/apps/basic-search/dev-config:/opt/basic-search/config:ro
      - basic-search-logs:/opt/basic-search/logs
      # 如果需要热重载，可以挂载源代码（需要调整 Dockerfile）
      # - ../services/apps/basic-search:/app:ro
    environment:
      - DEBUG=true
      - LOG_LEVEL=debug
      # 强制使用 Docker 环境配置（连接其他容器服务名，而非 localhost）
      - CONFIG_PATH=/opt/basic-search/config/config.docker.yaml

  opensearch:
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m" # 开发环境使用更少内存

  kafka:
    environment:
      KAFKA_NUM_PARTITIONS: 1 # 开发环境减少分区数
      KAFKA_ZOOKEEPER_CONNECTION_TIMEOUT_MS: 60000 # 增加连接超时
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT_MS: 60000 # 增加会话超时
      KAFKA_CUB_ZK_TIMEOUT: 120 # 增加预检查超时
      KAFKA_HEAP_OPTS: "-Xmx512m -Xms512m" # 限制内存
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf -Dzookeeper.sasl.client=false -Dzookeeper.session.timeout.ms=60000 -Dzookeeper.connection.timeout.ms=60000"
    command: "bash -c '/etc/confluent/docker/configure && /etc/confluent/docker/launch'"
